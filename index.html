<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sikkim Monastery Explorer</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html,body,#map { height:100%; margin:0; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index:1000;
      background: white; padding:12px; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15); font-family: system-ui, sans-serif;
      font-size:14px; width:260px;
    }
    #controls label { font-weight:600; display:block; margin-top:6px }
    input, select, datalist { width:100%; margin-top:6px; box-sizing:border-box; }
    button { margin-top:8px; width:100%; }
    .small { font-size:12px; color:#555; margin-top:8px }
    .error { color: #b00; font-weight:700 }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="controls">
    <h3 style="margin:0 0 6px 0">Sikkim Monastery Explorer</h3>

    <label for="startInput">Start</label>
    <input list="monasteriesList" id="startInput" placeholder="Type address, monastery name or 'My Location'" />
    <select id="startSelect"></select>

    <label for="endInput">End</label>
    <input list="monasteriesList" id="endInput" placeholder="Type address or monastery name" />
    <select id="endSelect"></select>

    <datalist id="monasteriesList"></datalist>

    <button id="routeBtn">Draw Route</button>
    <button id="clearRouteBtn">Clear Route</button>
    <button id="playSelectedAudioBtn">ðŸ”Š Play Selected Audio</button>

    <div class="small">Tip: type part of a monastery name in the Start/End input â€” the dropdown below will filter to matching monasteries.</div>
    <div class="small">Run locally with: <code>python -m http.server</code></div>
    <div id="msg" class="small"></div>
  </div>

  <!-- Leaflet & MarkerCluster JS (loaded from CDN) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  (function () {
      const msgEl = document.getElementById('msg');

      if (typeof L === 'undefined') {
          document.getElementById('controls').innerHTML = '<div class="error">Error: Leaflet failed to load.<br/>Please check your internet connection or run this file locally with network access.</div>';
          console.error('Leaflet is not defined.');
          return;
      }

      // ---------------- SIKKIM MONASTERIES ----------------
      const monasteries = {
          type: 'FeatureCollection',
          features: [
              { type:'Feature', properties:{name:'Rumtek Monastery', region:'Sikkim', desc:'Seat of the Karmapa', filename:'rumtek_monastery'}, geometry:{type:'Point', coordinates:[88.606,27.325]} },
              { type:'Feature', properties:{name:'Pemayangtse Monastery', region:'West Sikkim', desc:'Historic monastery near Pelling', filename:'pemayangtse_monastery'}, geometry:{type:'Point', coordinates:[88.262,27.299]} },
              { type:'Feature', properties:{name:'Tashiding Monastery', region:'West Sikkim', desc:'Holy monastery known for Bumchu', filename:'tashiding_monastery'}, geometry:{type:'Point', coordinates:[88.262,27.225]} },
              { type:'Feature', properties:{name:'Enchey Monastery', region:'Gangtok', desc:'Nyingma monastery near Gangtok', filename:'enchey_monastery'}, geometry:{type:'Point', coordinates:[88.613,27.342]} },
              { type:'Feature', properties:{name:'Phodong Monastery', region:'North Sikkim', desc:'Famous for Cham dances', filename:'phodong_monastery'}, geometry:{type:'Point', coordinates:[88.612,27.415]} },
              { type:'Feature', properties:{name:'Ralang Monastery', region:'South Sikkim', desc:'Important sacred monastery', filename:'ralang_monastery'}, geometry:{type:'Point', coordinates:[88.359,27.220]} },
              { type:'Feature', properties:{name:'Dubdi Monastery', region:'Yuksom', desc:'First monastery in Sikkim', filename:'dubdi_yuksom_trek_start'}, geometry:{type:'Point', coordinates:[88.253,27.372]} },
              { type:'Feature', properties:{name:'Lingdum (Ranka) Monastery', region:'Near Gangtok', desc:'Modern monastery also called Ranka', filename:'lingdum_ranka_monastery'}, geometry:{type:'Point', coordinates:[88.704,27.325]} },
              { type:'Feature', properties:{name:'Phensang Monastery', region:'Near Gangtok', desc:'Hosts dances before Losoong', filename:'phensang_monastery'}, geometry:{type:'Point', coordinates:[88.616,27.396]} },
              { type:'Feature', properties:{name:'Kartok Monastery', region:'Yuksom', desc:'Nyingma monastery near Kathok Lake', filename:'kartok_monastery'}, geometry:{type:'Point', coordinates:[88.258,27.381]} },
              { type:'Feature', properties:{name:'Sanga Choeling Monastery', region:'Pelling area', desc:'One of the oldest in Sikkim', filename:'sanga_choeling_monastery'}, geometry:{type:'Point', coordinates:[88.241,27.310]} },
              { type:'Feature', properties:{name:'Zang Dhok Palri Phodang (Durpin)', region:'Gangtok', desc:'Houses many rare scriptures', filename:'zang_dhok_palri_phodang'}, geometry:{type:'Point', coordinates:[88.614,27.313]} },
              { type:'Feature', properties:{name:'Samdruptse (Namchi) Monastery', region:'Namchi', desc:'Famous for the giant Guru statue', filename:'samdruptse_namchi_monastery'}, geometry:{type:'Point', coordinates:[88.349,27.173]} },
              { type:'Feature', properties:{name:'Tholung Monastery', region:'North Sikkim', desc:'Houses ancient relics; accessible by trek', filename:'tholung_monastery'}, geometry:{type:'Point', coordinates:[88.530,27.800]} },
              { type:'Feature', properties:{name:'Khecheopalri Monastery', region:'West Sikkim', desc:'Near sacred Khecheopalri Lake', filename:'khecheopalri_monastery'}, geometry:{type:'Point', coordinates:[88.195,27.360]} }
          ]
      };

      // ---------------- Map Setup ----------------
      const map = L.map('map').setView([27.33, 88.61], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

      const markers = (typeof L.markerClusterGroup === 'function') ? L.markerClusterGroup() : L.layerGroup();

      const startSelect = document.getElementById('startSelect');
      const endSelect = document.getElementById('endSelect');
      const monasteriesList = document.getElementById('monasteriesList');
      const startInput = document.getElementById('startInput');
      const endInput = document.getElementById('endInput');

      monasteries.features.forEach((f, idx) => {
          const [lon, lat] = f.geometry.coordinates;
          const p = f.properties;

          const popup = `
              <div style="width:230px">
                  <strong>${p.name}</strong><br>
                  <small>${p.region}</small>
                  <img src="${p.img || 'https://source.unsplash.com/400x300/?monastery'}" style="width:100%;margin-top:6px;border-radius:6px"/>
                  <p style="font-size:13px;margin:6px 0">${p.desc}</p>
                  <button onclick="window._playAudio(${idx})">ðŸ”Š Play Audio</button>
                  <button onclick="window._fetchNearby && window._fetchNearby(${lat},${lon},'${p.name.replace(/'/g,"\\'")}')">Nearby Attractions</button>
              </div>`;

          const m = L.marker([lat, lon]).bindPopup(popup);
          markers.addLayer(m);

          const opt1 = new Option(p.name, idx);
          const opt2 = new Option(p.name, idx);
          startSelect.appendChild(opt1);
          endSelect.appendChild(opt2);

          const o = document.createElement('option');
          o.value = p.name;
          monasteriesList.appendChild(o);
      });

      map.addLayer(markers);
      try { map.fitBounds(markers.getBounds().pad(0.2)); } catch(e) {}

      // ---------------- Helpers ----------------
      function populateSelectFiltered(selectEl, filterText, includeMyLocation) {
          const q = (filterText || '').toLowerCase();
          selectEl.innerHTML = '';
          const placeholder = new Option('-- choose monastery --', '');
          placeholder.disabled = true;
          placeholder.selected = true;
          selectEl.appendChild(placeholder);

          if (includeMyLocation) {
              const myOpt = new Option('My Location', 'my_location');
              selectEl.appendChild(myOpt);
          }

          monasteries.features.forEach((f, idx) => {
              const name = f.properties.name || '';
              if (!q || name.toLowerCase().includes(q)) {
                  const opt = new Option(name, idx);
                  selectEl.appendChild(opt);
              }
          });
      }

      populateSelectFiltered(startSelect, '', true);
      populateSelectFiltered(endSelect, '', false);

      startInput.addEventListener('input', e => {
          populateSelectFiltered(startSelect, e.target.value, true);
      });
      endInput.addEventListener('input', e => {
          populateSelectFiltered(endSelect, e.target.value, false);
      });

      startSelect.addEventListener('change', e => {
          const v = e.target.value;
          if (v === 'my_location') startInput.value = 'My Location';
          else if (v === '') startInput.value = '';
          else startInput.value = monasteries.features[parseInt(v)].properties.name;
      });
      endSelect.addEventListener('change', e => {
          const v = e.target.value;
          if (v === '') endInput.value = '';
          else endInput.value = monasteries.features[parseInt(v)].properties.name;
      });

      function getCurrentLocation() {
          return new Promise((resolve, reject) => {
              if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
              navigator.geolocation.getCurrentPosition(pos => resolve([pos.coords.longitude, pos.coords.latitude]), err => reject(err), { enableHighAccuracy: true });
          });
      }

      async function geocode(query, dropdownValue) {
          if (dropdownValue === 'my_location') return await getCurrentLocation();
          if (typeof dropdownValue === 'string' && dropdownValue !== '' && !isNaN(parseInt(dropdownValue))) {
              return monasteries.features[parseInt(dropdownValue)].geometry.coordinates;
          }

          if (query && query.trim().toLowerCase() === 'my location') {
              return await getCurrentLocation();
          }

          if (query) {
              const q = query.trim().toLowerCase();
              const found = monasteries.features.find(f => (f.properties.name || '').toLowerCase() === q);
              if (found) return found.geometry.coordinates;

              try {
                  msgEl.textContent = 'Geocoding...';
                  const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(query);
                  const res = await fetch(url, {headers: {'Accept': 'application/json'}});
                  if (!res.ok) throw new Error('Geocoding request failed');
                  const json = await res.json();
                  msgEl.textContent = '';
                  if (json && json.length) return [parseFloat(json[0].lon), parseFloat(json[0].lat)];
                  throw new Error('No results from geocoder');
              } catch (err) {
                  msgEl.textContent = '';
                  throw err;
              }
          }

          throw new Error('No input provided');
      }

      // ---------------- Routing ----------------
      let routeLayer = null;

      async function drawRoute(startQ, startDropdown, endQ, endDropdown) {
          try {
              msgEl.textContent = 'Calculating route...';
              const s = await geocode(startQ, startDropdown);
              const e = await geocode(endQ, endDropdown);

              if (!s || !e) throw new Error('Could not determine coordinates');

              if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }

              const url = `https://router.project-osrm.org/route/v1/driving/${s[0]},${s[1]};${e[0]},${e[1]}?overview=full&geometries=geojson`;
              const res = await fetch(url);
              if (!res.ok) throw new Error('Routing service error');
              const data = await res.json();
              if (!data || !data.routes || !data.routes[0]) throw new Error('No route found');

              routeLayer = L.geoJSON(data.routes[0].geometry, { color: '#1976d2', weight: 4 }).addTo(map);
              map.fitBounds(routeLayer.getBounds().pad(0.2));
              msgEl.textContent = '';
          } catch (err) {
              console.error(err);
              msgEl.innerHTML = '<span class="error">Routing failed:</span> ' + (err.message || err);
              setTimeout(() => { if (msgEl.innerHTML.includes('Routing failed')) msgEl.textContent = ''; }, 5000);
              throw err;
          }
      }

      document.getElementById('routeBtn').addEventListener('click', async () => {
          const startQ = startInput.value || '';
          const endQ = endInput.value || '';
          const startDropdown = startSelect.value || '';
          const endDropdown = endSelect.value || '';

          if ((startQ.trim() === '' && startDropdown === '') || (endQ.trim() === '' && endDropdown === '')) {
              alert('Please enter or select both start and end');
              return;
          }

          try { await drawRoute(startQ, startDropdown, endQ, endDropdown); } catch(e){}
      });

      document.getElementById('clearRouteBtn').addEventListener('click', () => {
          if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      });

      // ---------------- Nearby Attractions ----------------
      window._fetchNearby = async function (lat, lon, name) {
          try {
              msgEl.textContent = 'Searching nearby attractions...';
              const query = `\n[out:json][timeout:25];\n(node(around:3000,${lat},${lon})[tourism];node(around:3000,${lat},${lon})[historic];node(around:3000,${lat},${lon})[amenity~"restaurant|cafe|hotel",i];);\nout 10;`;
              const res = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body:query });
              if (!res.ok) throw new Error('Overpass API error');
              const data = await res.json();
              msgEl.textContent = '';
              if (!data.elements || !data.elements.length) { alert('No nearby attractions found'); return; }

              const layer = L.layerGroup();
              data.elements.forEach(el => {
                  if (!el.lat || !el.lon) return;
                  const title = (el.tags && (el.tags.name || el.tags.tourism || el.tags.historic || el.tags.amenity)) || 'Attraction';
                  L.marker([el.lat, el.lon], { icon: L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[20,20] }) }).bindPopup(`<strong>${title}</strong>`).addTo(layer);
              });
              layer.addTo(map);
              try { map.fitBounds(layer.getBounds().pad(0.3)); } catch(e) {}
              setTimeout(() => map.removeLayer(layer), 35000);
          } catch (err) {
              console.error(err);
              alert('Nearby attractions failed: ' + (err.message || err));
          }
      };

      // ---------------- Audio Playback ----------------
      window._audioPlayer = new Audio();

      window._playAudio = function(input) {
          const idx = parseInt(input);

          if (isNaN(idx) || idx < 0 || idx >= monasteries.features.length) {
              console.error('Invalid index provided for _playAudio:', input);
              msgEl.innerHTML = '<span class="error">Audio Error:</span> Invalid monastery selection.';
              setTimeout(() => { if (msgEl.innerHTML.includes('Audio Error:')) msgEl.textContent = ''; }, 4000);
              return;
          }

          const p = monasteries.features[idx].properties;
          const fileName = p.filename || p.name.toLowerCase().replace(/[^a-z0-9]+/g,'_');
          const audioPath = `audio/${fileName}.mp3`;

          _audioPlayer.src = audioPath;
          _audioPlayer.play().then(() => {
              msgEl.textContent = `Playing audio for: ${p.name}`;
              setTimeout(() => { msgEl.textContent = ''; }, 3000);
          }).catch(err => {
              console.error('Audio playback failed:', err);
              msgEl.innerHTML = `<span class="error">Audio Error:</span> File ${audioPath} not found for ${p.name}. Check your 'audio' folder and file names.`;
              setTimeout(() => { if (msgEl.innerHTML.includes('Audio Error:')) msgEl.textContent = ''; }, 6000);
          });
      };

      document.getElementById('playSelectedAudioBtn').addEventListener('click', () => {
          const selectedValue = document.getElementById('startSelect').value || document.getElementById('endSelect').value; 
          if (selectedValue === '' || selectedValue === 'my_location') {
              alert('Please select a monastery first from the Start or End dropdown.');
              return;
          }
          window._playAudio(selectedValue); 
      });
  })();
</script>
</body>
</html>
